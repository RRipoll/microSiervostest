#!/bin/bash

# Pre-commit hook for automated code review
# Ensures code quality before commits reach the repository

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
GRADLE_CMD="./gradlew"
STAGED_JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.java$' | head -20)
PROJECT_ROOT=$(git rev-parse --show-toplevel)

echo -e "${BLUE}ğŸ” TestJava Price Service - Automated Code Review${NC}"
echo -e "${BLUE}================================================${NC}"

# Function to print status
print_status() {
    local status=$1
    local message=$2
    if [ "$status" = "success" ]; then
        echo -e "${GREEN}âœ… $message${NC}"
    elif [ "$status" = "warning" ]; then
        echo -e "${YELLOW}âš ï¸  $message${NC}"
    elif [ "$status" = "error" ]; then
        echo -e "${RED}âŒ $message${NC}"
    else
        echo -e "${BLUE}â„¹ï¸  $message${NC}"
    fi
}

# Check if there are any Java files to review
if [ -z "$STAGED_JAVA_FILES" ]; then
    print_status "info" "No Java files to review in this commit"
    exit 0
fi

print_status "info" "Reviewing ${#STAGED_JAVA_FILES[@]} Java files..."

# 1. Code Formatting Check
echo -e "\n${BLUE}ğŸ¨ Step 1: Code Formatting Validation${NC}"
if command -v google-java-format >/dev/null 2>&1; then
    formatting_issues=0
    for file in $STAGED_JAVA_FILES; do
        if [ -f "$file" ]; then
            if ! google-java-format --dry-run --set-exit-if-changed "$file" >/dev/null 2>&1; then
                print_status "warning" "Formatting issues in $file"
                formatting_issues=$((formatting_issues + 1))
            fi
        fi
    done
    
    if [ $formatting_issues -eq 0 ]; then
        print_status "success" "All files are properly formatted"
    else
        print_status "warning" "$formatting_issues files have formatting issues"
        echo -e "${YELLOW}Run: google-java-format -i <files> to fix formatting${NC}"
    fi
else
    print_status "warning" "Google Java Format not installed, skipping formatting check"
fi

# 2. Compilation Check
echo -e "\n${BLUE}âš™ï¸  Step 2: Compilation Validation${NC}"
if $GRADLE_CMD compileJava compileTestJava --quiet; then
    print_status "success" "Code compiles successfully"
else
    print_status "error" "Compilation failed"
    echo -e "${RED}Fix compilation errors before committing${NC}"
    exit 1
fi

# 3. Unit Tests Execution
echo -e "\n${BLUE}ğŸ§ª Step 3: Fast Unit Tests${NC}"
if $GRADLE_CMD fastTest --quiet; then
    print_status "success" "All unit tests pass"
else
    print_status "error" "Unit tests failed"
    echo -e "${RED}Fix failing tests before committing${NC}"
    exit 1
fi

# 4. Static Code Analysis
echo -e "\n${BLUE}ğŸ” Step 4: Static Code Analysis${NC}"
if $GRADLE_CMD checkstyleMain checkstyleTest --quiet; then
    print_status "success" "Checkstyle validation passed"
else
    print_status "warning" "Checkstyle issues detected"
    echo -e "${YELLOW}View report: build/reports/checkstyle/main.html${NC}"
fi

# 5. SpotBugs Analysis
echo -e "\n${BLUE}ğŸ› Step 5: Bug Detection Analysis${NC}"
if $GRADLE_CMD spotbugsMain --quiet; then
    print_status "success" "No bugs detected by SpotBugs"
else
    print_status "warning" "Potential bugs detected"
    echo -e "${YELLOW}View report: build/reports/spotbugs/main.html${NC}"
fi

# 6. PMD Analysis
echo -e "\n${BLUE}ğŸ“Š Step 6: Code Quality Analysis${NC}"
if $GRADLE_CMD pmdMain --quiet; then
    print_status "success" "PMD analysis passed"
else
    print_status "warning" "PMD issues detected"
    echo -e "${YELLOW}View report: build/reports/pmd/main.html${NC}"
fi

# 7. Dependency Vulnerability Check
echo -e "\n${BLUE}ğŸ›¡ï¸ Step 7: Security Vulnerability Scan${NC}"
if $GRADLE_CMD dependencyCheckAnalyze --quiet; then
    print_status "success" "No security vulnerabilities detected"
else
    print_status "warning" "Potential security vulnerabilities found"
    echo -e "${YELLOW}View report: build/reports/dependency-check-report.html${NC}"
fi

# 8. Code Coverage Impact Analysis
echo -e "\n${BLUE}ğŸ“Š Step 8: Coverage Impact Analysis${NC}"
# Run tests with coverage to check impact
if $GRADLE_CMD jacocoTestReport --quiet; then
    # Extract coverage percentage (simplified)
    coverage_file="build/reports/jacoco/test/html/index.html"
    if [ -f "$coverage_file" ]; then
        print_status "success" "Coverage analysis completed"
        echo -e "${BLUE}â„¹ï¸  View detailed coverage: $coverage_file${NC}"
    else
        print_status "warning" "Coverage report not generated"
    fi
else
    print_status "warning" "Coverage analysis failed"
fi

# 9. Commit Message Validation
echo -e "\n${BLUE}ğŸ“ Step 9: Commit Message Validation${NC}"
commit_msg_file="$PROJECT_ROOT/.git/COMMIT_EDITMSG"
if [ -f "$commit_msg_file" ]; then
    commit_msg=$(cat "$commit_msg_file")
    
    # Check commit message format (Conventional Commits)
    if echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .{1,}"; then
        print_status "success" "Commit message follows conventional format"
    else
        print_status "warning" "Commit message should follow conventional commits format"
        echo -e "${YELLOW}Format: type(scope): description${NC}"
        echo -e "${YELLOW}Example: feat(api): add price validation endpoint${NC}"
    fi
    
    # Check for minimum message length
    if [ ${#commit_msg} -lt 10 ]; then
        print_status "warning" "Commit message is too short (minimum 10 characters)"
    fi
else
    print_status "info" "Commit message validation skipped (interactive commit)"
fi

# 10. Large File Detection
echo -e "\n${BLUE}ğŸ“¦ Step 10: Large File Detection${NC}"
large_files=$(git diff --cached --name-only | xargs -I {} find {} -size +1M 2>/dev/null | head -5)
if [ -n "$large_files" ]; then
    print_status "warning" "Large files detected in commit:"
    echo "$large_files"
    echo -e "${YELLOW}Consider using Git LFS for large files${NC}"
else
    print_status "success" "No large files detected"
fi

# Summary Report
echo -e "\n${BLUE}ğŸ“‹ Pre-commit Review Summary${NC}"
echo -e "${BLUE}===============================${NC}"
print_status "success" "Automated code review completed"
print_status "info" "Files reviewed: $(echo $STAGED_JAVA_FILES | wc -w)"
print_status "info" "Review duration: $(date)"

# Optional: Generate review checklist
cat << 'EOF' > .git/review-checklist.md
# ğŸ“‹ Code Review Checklist

## Automated Checks âœ…
- [ ] âœ… Code compiles successfully
- [ ] âœ… Unit tests pass
- [ ] âœ… Static analysis completed
- [ ] âœ… Security scan passed
- [ ] âœ… Coverage analysis done

## Manual Review Required
- [ ] Business logic correctness
- [ ] API design consistency
- [ ] Error handling completeness
- [ ] Documentation updates
- [ ] Performance considerations

## Architecture Review
- [ ] Follows hexagonal architecture
- [ ] Proper layer separation
- [ ] SOLID principles adherence
- [ ] Design patterns usage

## Security Review
- [ ] Input validation
- [ ] Authorization checks
- [ ] Data sanitization
- [ ] Logging security (no secrets)

Generated by automated pre-commit hook
EOF

print_status "info" "Review checklist generated: .git/review-checklist.md"

echo -e "\n${GREEN}ğŸ‰ Pre-commit review completed successfully!${NC}"
echo -e "${BLUE}â„¹ï¸  Ready for peer review and pull request${NC}"

exit 0